name: Deploy API

on:
  push:
    tags:
      - "deploy-*"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      # ------------------------------------------------------------------
      # Build Docker test image (api/tests/Dockerfile.test)
      # ------------------------------------------------------------------
      - name: Build test image
        run: |
          docker build -f api/tests/Dockerfile.test -t wine-api-test .
      # ------------------------------------------------------------------
      # Run integration tests and generate XML report
      # ------------------------------------------------------------------      
      - name: Run tests
        run: |
          docker run --rm \
           -e API_URL="http://localhost:7860"\
           -e MLFLOW_TRACKING_URI="${{ secrets.BACKEND_STORE_URI }}" \
           -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
           -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
           -e NEON_URI="${{ secrets.NEON_TEST }}" \
            wine-api-test \
            /bin/bash -c "uvicorn app:app --host 0.0.0.0 --port 7860 & python3 wait_for_api.py && pytest tests -v --junitxml=/github/workspace/test-results-api.xml"
      # ------------------------------------------------------------------
      # Upload API test results as artifact
      # ------------------------------------------------------------------
      - name: Upload API test results artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-test-results-${{ github.sha }}
          path: test-results-api.xml
          retention-days: 7

  deploy:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      # ------------------------------------------------------------------
      # Install Hugging Face client
      # ------------------------------------------------------------------ 
      - name: Install HF client
        run: pip install huggingface_hub
       # ------------------------------------------------------------------
      # Prepare HuggingFace Space folder
      # ------------------------------------------------------------------ 
      - name: Prepare HuggingFace Space folder
        run: |
          mkdir hf-space
          cp api/app.py hf-space/app.py
          cp api/requirements-api.txt hf-space/requirements.txt
          cp api/Dockerfile hf-space/Dockerfile
      # ------------------------------------------------------------------
      # Push to HuggingFace Space
      # ------------------------------------------------------------------ 
      - name: Push to HuggingFace Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python3 - <<EOF
          from huggingface_hub import HfApi
          import os
          api = HfApi()
          repo_id = "corbenol/wine-price-predictor"
          token = os.getenv("HF_TOKEN")
          if not token:
            print("Erreur: Le jeton HF_TOKEN n'a pas été trouvé dans l'environnement.")
            exit(1)
          api.upload_folder(
              folder_path="hf-space",
              repo_id=repo_id,
              repo_type="space",
              token=token,
              path_in_repo=""
          )
          print("Déploiement terminé sur HuggingFace !")
          EOF
