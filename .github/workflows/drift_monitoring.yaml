name: Drift mod√®le

# D√©clenche le workflow manuellement ou selon un calendrier hebdomadaire
on:
   push:
    tags:
      - "drift-*"

   #workflow_dispatch:
  #schedule:
    # S'ex√©cute chaque lundi √† 02:00 UTC
  #  - cron: '0 2 * * 1' 

jobs:
  monitor_drift:
    runs-on: ubuntu-latest
    
    # 1. Montage du conteneur Docker
    steps:
      - name: Checkout du Code
        uses: actions/checkout@v4

      - name: Construire et Ex√©cuter le Conteneur du Moniteur de D√©rive
        # Utilisation de 'docker run' pour ex√©cuter le script dans un environnement conteneuris√©
        run: |
          # 1. Construction de l'image Docker √† partir du r√©pertoire 'drift'
          # Le chemin du Dockerfile est relatif √† la racine du d√©p√¥t.
          docker build -f drift/Dockerfile.drift -t drift-monitor . 
                    
          # 2. Ex√©cution du conteneur
          docker run \
            --rm \
            -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
            -e TRACK_URI="${{ secrets.BACKEND_STORE_URI }}" \
            -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
            -e ARTIFACT_DATA=${{ secrets.ARTIFACT_DATA }} \
            -e DRIFT_THRESHOLD=0.05 \
            drift-monitor python3 drift_monitor.py
      
      # Les √©tapes suivantes ne sont pas n√©cessaires car Docker renvoie d√©j√† le code de sortie (0 ou 1)
      # du script python, ce qui fait √©chouer l'√©tape 'docker run' si drift_monitor.py renvoie 1.
      
      # Le statut du job sera 'Success' si le script a r√©ussi (exit 0) ou 'Failure' si la d√©rive est d√©tect√©e (exit 1).
      - name: Rapport sur la Surveillance
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "‚úÖ Succ√®s: Le mod√®le a pass√© le test de d√©rive (performance stable)."
          else
            echo "üö® √âCHEC: D√âRIVE DU MOD√àLE D√âTECT√âE."
            echo "Le mod√®le a d√©pass√© le seuil de d√©rive de 0.05. Veuillez inspecter les donn√©es de test S3 et le mod√®le MLflow."
            exit 1
          fi